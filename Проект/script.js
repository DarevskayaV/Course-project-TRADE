// =============================================================================
// ОСНОВНОЙ МОДУЛЬ УПРАВЛЕНИЯ КАРУСЕЛЬЮ ТОВАРОВ
// 
// КАРУСЕЛЬ (Carousel) - UI-компонент для поочередного показа элементов
// с возможностью навигации вперед/назад и автоматической прокрутки
// =============================================================================

/**
 * ОЖИДАНИЕ ПОЛНОЙ ЗАГРУЗКИ DOM
 * 
 * DOMContentLoaded - событие, которое срабатывает когда весь HTML загружен и parsed,
 * но не обязательно когда все изображения/стили загружены
 * 
 * ТЕОРИЯ: Браузер загружает страницу в несколько этапов:
 * 1. Парсинг HTML → 2. Построение DOM → 3. Загрузка внешних ресурсов
 * DOMContentLoaded срабатывает после этапа 2
 */
document.addEventListener("DOMContentLoaded", () => {
  // ===========================================================================
  // ПОЛУЧЕНИЕ ССЫЛОК НА DOM-ЭЛЕМЕНТЫ
  // ===========================================================================

  /**
   * querySelector() - универсальный метод поиска элементов по CSS-селектору
   * Возвращает ПЕРВЫЙ найденный элемент
   * 
   * .carousel-track - контейнер, который будет перемещаться для смены слайдов
   */
  const track = document.querySelector(".carousel-track");
  
  /**
   * КНОПКИ НАВИГАЦИИ
   * .prev - кнопка "назад" (предыдущий слайд)
   * .next - кнопка "вперед" (следующий слайд)
   */
  const prevButton = document.querySelector(".prev");
  const nextButton = document.querySelector(".next");

  // ===========================================================================
  // СОСТОЯНИЕ КАРУСЕЛИ (STATE)
  // ===========================================================================

  /**
   * currentIndex - ТЕКУЩИЙ АКТИВНЫЙ СЛАЙД
   * Начинается с 0 (первый элемент массива)
   * 
   * ТЕОРИЯ: Состояние (state) - данные, которые определяют текущее поведение компонента
   * При изменении состояния компонент должен перерисоваться
   */
  let currentIndex = 0;
  
  /**
   * currentProducts - МАССИВ ВСЕХ ТОВАРОВ ДЛЯ ОТОБРАЖЕНИЯ
   * productStore.getAllProducts() - метод из внешнего модуля products.js
   * который возвращает массив всех товаров
   * 
   * ПРЕДПОЛАГАЕМАЯ СТРУКТУРА productStore:
   * {
   *   getAllProducts: function() {
   *     return [
   *       { name: "Товар 1", price: "100 Br", image: "img1.jpg" },
   *       { name: "Товар 2", price: "200 Br", image: "img2.jpg" }
   *     ];
   *   }
   * }
   */
  let currentProducts = productStore.getAllProducts();

  // ===========================================================================
  // ФУНКЦИЯ РЕНДЕРИНГА ТОВАРОВ В КАРУСЕЛИ
  // ===========================================================================

  /**
   * Создает HTML-элементы для каждого товара и добавляет их в карусель
   * @param {Array} products - массив объектов товаров
   */
  function renderProducts(products) {
    /**
     * ОЧИСТКА СУЩЕСТВУЮЩЕГО СОДЕРЖИМОГО
     * innerHTML = "" - удаляет всех потомков элемента
     * 
     * ТЕОРИЯ: Это необходимо чтобы при повторном вызове функции
     * не дублировались товары
     */
    track.innerHTML = "";

    /**
     * СОЗДАНИЕ ЭЛЕМЕНТОВ ДЛЯ КАЖДОГО ТОВАРА
     * forEach() - метод массива для итерации по элементам
     */
    products.forEach((product) => {
      /**
       * СОЗДАНИЕ КОНТЕЙНЕРА ДЛЯ ОДНОГО ТОВАРА
       * document.createElement() - создает элемент в памяти (не на странице)
       * 'div' - тип создаваемого элемента
       */
      const item = document.createElement("div");
      
      /**
       * classList.add() - добавляет CSS-класс к элементу
       * 'carousel-item' - класс для стилизации карточки товара
       */
      item.classList.add("carousel-item");

      /**
       * ЗАПОЛНЕНИЕ HTML-СОДЕРЖИМОГО КАРТОЧКИ
       * Шаблонная строка (template literal) позволяет вставлять переменные
       * через ${expression}
       * 
       * СТРУКТУРА КАРТОЧКИ:
       * - <img> - изображение товара
       * - <p class="product-name"> - название товара
       * - <p class="product-price"> - цена товара
       */
      item.innerHTML = `
        <img src="${product.image}" alt="${product.name}" />
        <p class="product-name">${product.name}</p>
        <p class="product-price">${product.price}</p>
      `;

      /**
       * ДОБАВЛЕНИЕ КАРТОЧКИ В КОНТЕЙНЕР КАРУСЕЛИ
       * appendChild() - физически добавляет элемент на страницу
       */
      track.appendChild(item);
    });

    /**
     * СОХРАНЕНИЕ СОЗДАННЫХ ЭЛЕМЕНТОВ В ПЕРЕМЕННУЮ СОСТОЯНИЯ
     * Array.from() - преобразует NodeList (коллекцию DOM-элементов) в массив
     * track.children - все непосредственные потомки элемента track
     * 
     * ТЕОРИЯ: Работать с массивом удобнее чем с NodeList
     * так как у массива больше методов (forEach, map, filter и т.д.)
     */
    currentProducts = Array.from(track.children);
    
    /**
     * ПОКАЗ ПЕРВОГО СЛАЙДА ПОСЛЕ ЗАГРУЗКИ ВСЕХ ТОВАРОВ
     * showSlide(0) - показывает слайд с индексом 0 (первый)
     */
    showSlide(0);
  }

  // ===========================================================================
  // ФУНКЦИЯ УПРАВЛЕНИЯ ОТОБРАЖЕНИЕМ СЛАЙДОВ
  // ===========================================================================

  /**
   * Перемещает карусель к указанному слайду
   * @param {number} index - индекс слайда для показа
   */
  function showSlide(index) {
    /**
     * ЗАЩИТА ОТ ОШИБОК ПРИ ОТСУТСТВИИ ТОВАРОВ
     * Если массив пустой - выходим из функции
     */
    if (currentProducts.length === 0) return;

    /**
     * ОБРАБОТКА ГРАНИЧНЫХ СЛУЧАЕВ - ЦИКЛИЧЕСКАЯ НАВИГАЦИЯ
     * 
     * Если индекс меньше 0 (пользователь нажал "назад" на первом слайде) -
     * переходим к последнему слайду
     */
    if (index < 0) index = currentProducts.length - 1;
    
    /**
     * Если индекс больше или равен количеству слайдов (пользователь нажал 
     * "вперед" на последнем слайде) - переходим к первому слайду
     */
    if (index >= currentProducts.length) index = 0;

    /**
     * ОБНОВЛЕНИЕ ТЕКУЩЕГО ИНДЕКСА
     * Сохраняем новый индекс в состоянии компонента
     */
    currentIndex = index;
    
    /**
     * РАСЧЕТ СМЕЩЕНИЯ ДЛЯ CSS TRANSFORM
     * 
     * Каждый слайд занимает 100% ширины контейнера
     * Чтобы показать N-й слайд, нужно сместить контейнер на -N * 100%
     * 
     * Пример: 
     * - index = 0 → offset = 0% (показываем первый слайд)
     * - index = 1 → offset = -100% (показываем второй слайд)
     * - index = 2 → offset = -200% (показываем третий слайд)
     */
    const offset = -index * 100;
    
    /**
     * ПРИМЕНЕНИЕ АНИМАЦИИ ПЕРЕМЕЩЕНИЯ
     * transform: translateX() - CSS-свойство для горизонтального перемещения
     * 
     * ТЕОРИЯ: transform лучше чем margin-left или left для анимаций,
     * так как оно использует аппаратное ускорение браузера
     */
    track.style.transform = `translateX(${offset}%)`;
  }

  // ===========================================================================
  // НАСТРОЙКА ОБРАБОТЧИКОВ СОБЫТИЙ ДЛЯ КНОПОК НАВИГАЦИИ
  // ===========================================================================

  /**
   * ОБРАБОТЧИК ДЛЯ КНОПКИ "НАЗАД"
   * При клике показываем предыдущий слайд (currentIndex - 1)
   */
  prevButton.addEventListener("click", () => {
    /**
     * Стрелочная функция () => showSlide(currentIndex - 1)
     * вызывается при каждом клике на кнопку
     */
    showSlide(currentIndex - 1);
  });

  /**
   * ОБРАБОТЧИК ДЛЯ КНОПКИ "ВПЕРЁД"
   * При клике показываем следующий слайд (currentIndex + 1)
   */
  nextButton.addEventListener("click", () => {
    showSlide(currentIndex + 1);
  });

  // ===========================================================================
  // ИНИЦИАЛИЗАЦИЯ КАРУСЕЛИ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ
  // ===========================================================================

  /**
   * ПЕРВОНАЧАЛЬНЫЙ РЕНДЕРИНГ ТОВАРОВ
   * Вызываем функцию renderProducts с начальным массивом товаров
   * Эта функция:
   * 1. Очистит контейнер
   * 2. Создаст карточки товаров
   * 3. Покажет первый слайд
   */
  renderProducts(currentProducts);

  // ===========================================================================
  // НАСТРОЙКА АВТОМАТИЧЕСКОЙ ПРОКРУТКИ
  // ===========================================================================

  /**
   * setInterval() - ТАЙМЕР ДЛЯ АВТОМАТИЧЕСКОЙ СМЕНЫ СЛАЙДОВ
   * 
   * @param {Function} () => showSlide(currentIndex + 1) - функция для выполнения
   * @param {number} 4000 - интервал в миллисекундах (4 секунды)
   * 
   * ТЕОРИЯ: setInterval выполняет функцию повторно через указанный интервал
   * Возвращает ID таймера, который можно использовать для остановки (clearInterval)
   */
  setInterval(() => {
    /**
     * Каждые 4 секунды показываем следующий слайд
     * Функция showSlide сама позаботится о циклической навигации
     * когда достигнут конец списка
     */
    showSlide(currentIndex + 1);
  }, 4000);
});